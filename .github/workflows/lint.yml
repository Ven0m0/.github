# Reusable Linting & Formatting Workflow
# Supports: ESLint, Prettier, Ruff, Black, actionlint, yamllint, markdownlint, shellcheck
#
# Required secrets: none
#
# Usage example:
# jobs:
#   lint:
#     uses: Ven0m0/.github/.github/workflows/lint.yml@main
#     with:
#       run-eslint: true
#       run-prettier: true
#       run-actionlint: true

name: Lint & Format (Reusable)

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      run-eslint:
        description: 'Run ESLint for JavaScript/TypeScript'
        required: false
        type: boolean
        default: false
      run-prettier:
        description: 'Run Prettier format check'
        required: false
        type: boolean
        default: false
      run-ruff:
        description: 'Run Ruff for Python'
        required: false
        type: boolean
        default: false
      run-black:
        description: 'Run Black for Python'
        required: false
        type: boolean
        default: false
      run-mypy:
        description: 'Run mypy for Python type checking'
        required: false
        type: boolean
        default: false
      run-actionlint:
        description: 'Run actionlint for GitHub Actions workflows'
        required: false
        type: boolean
        default: true
      run-yamllint:
        description: 'Run yamllint for YAML files'
        required: false
        type: boolean
        default: false
      run-markdownlint:
        description: 'Run markdownlint for Markdown files'
        required: false
        type: boolean
        default: false
      run-shellcheck:
        description: 'Run shellcheck for shell scripts'
        required: false
        type: boolean
        default: false
      eslint-extensions:
        description: 'File extensions for ESLint (e.g., "js,ts,jsx,tsx")'
        required: false
        type: string
        default: 'js,ts,jsx,tsx'
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 10

permissions:
  contents: read

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      pull-requests: write

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js for JS/TS linting
        if: inputs.run-eslint || inputs.run-prettier
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        if: inputs.run-eslint || inputs.run-prettier
        run: npm ci --prefer-offline --no-audit

      - name: Run ESLint
        if: inputs.run-eslint
        run: |
          npx eslint . --ext ${{ inputs.eslint-extensions }} --max-warnings 0
        continue-on-error: false

      - name: Run Prettier check
        if: inputs.run-prettier
        run: |
          npx prettier --check .
        continue-on-error: false

      - name: Setup Python for Python linting
        if: inputs.run-ruff || inputs.run-black || inputs.run-mypy
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: Install Python linting tools
        if: inputs.run-ruff || inputs.run-black || inputs.run-mypy
        run: |
          pip install --upgrade pip
          pip install ruff black mypy

      - name: Run Ruff check
        if: inputs.run-ruff
        run: ruff check .
        continue-on-error: false

      - name: Run Ruff format check
        if: inputs.run-ruff
        run: ruff format --check .
        continue-on-error: false

      - name: Run Black check
        if: inputs.run-black
        run: black --check .
        continue-on-error: false

      - name: Run mypy
        if: inputs.run-mypy
        run: mypy .
        continue-on-error: false

      - name: Run actionlint
        if: inputs.run-actionlint
        uses: reviewdog/action-actionlint@67088c66ad19d797e3c45f86fce88fae5ebdf5e2 # v1.60.0
        with:
          level: error
          reporter: github-check
          fail_on_error: true

      - name: Run yamllint
        if: inputs.run-yamllint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3.1.1
        with:
          file_or_dir: .
          config_file: .yamllint.yml
          strict: true
          no_warnings: true

      - name: Run markdownlint
        if: inputs.run-markdownlint
        uses: DavidAnson/markdownlint-cli2-action@db43aef879112c3119a410d69f66701e0d530809 # v18.0.0
        with:
          globs: '**/*.md'
          fix: false

      - name: Run shellcheck
        if: inputs.run-shellcheck
        uses: ludeeus/action-shellcheck@00b27aa7cb85167568cb48a3838b75f4265f2bca # 2.0.0
        with:
          scandir: ${{ inputs.working-directory }}
          severity: warning
          check_together: 'yes'

      - name: Super-Linter
        if: |
          !inputs.run-eslint &&
          !inputs.run-prettier &&
          !inputs.run-ruff &&
          !inputs.run-black &&
          !inputs.run-actionlint &&
          !inputs.run-yamllint &&
          !inputs.run-markdownlint &&
          !inputs.run-shellcheck
        uses: super-linter/super-linter@b92721f792f381cedc002ecdbb9847a15ece5bb8 # v7.2.0
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          LINTER_RULES_PATH: /
          FILTER_REGEX_EXCLUDE: '.*/(node_modules|dist|build|vendor)/.*'
