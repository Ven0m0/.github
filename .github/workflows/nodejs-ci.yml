# Reusable Node.js CI Workflow
# Supports: npm, yarn, pnpm, bun
#
# Required secrets: none (unless publishing)
# Optional secrets:
#   - NPM_TOKEN: for package publishing
#   - CODECOV_TOKEN: for code coverage uploads
#
# Usage example:
# jobs:
#   test:
#     uses: Ven0m0/.github/.github/workflows/nodejs-ci.yml@main
#     with:
#       node-version: '20'
#       package-manager: 'npm'
#       run-tests: true
#       run-build: true

name: Node.js CI (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use (supports matrix as JSON array)'
        required: false
        type: string
        default: '20'
      package-manager:
        description: 'Package manager: npm, yarn, pnpm, or bun'
        required: false
        type: string
        default: 'npm'
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      run-install:
        description: 'Run package installation'
        required: false
        type: boolean
        default: true
      run-lint:
        description: 'Run linting (npm run lint)'
        required: false
        type: boolean
        default: true
      run-tests:
        description: 'Run tests (npm run test)'
        required: false
        type: boolean
        default: true
      run-build:
        description: 'Run build (npm run build)'
        required: false
        type: boolean
        default: true
      coverage:
        description: 'Generate and upload code coverage'
        required: false
        type: boolean
        default: false
      cache-dependency-path:
        description: 'Path to package-lock.json, yarn.lock, pnpm-lock.yaml, or bun.lockb'
        required: false
        type: string
        default: ''
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 15
    secrets:
      NPM_TOKEN:
        description: 'NPM authentication token (optional)'
        required: false
      CODECOV_TOKEN:
        description: 'Codecov upload token (optional)'
        required: false

permissions:
  contents: read

jobs:
  nodejs-ci:
    name: Node.js ${{ inputs.node-version }} (${{ inputs.package-manager }})
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          cache-dependency-path: ${{ inputs.cache-dependency-path }}

      - name: Setup pnpm
        if: inputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: 9

      - name: Setup Bun
        if: inputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: latest

      - name: Configure npm authentication
        if: inputs.package-manager == 'npm'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
          fi

      - name: Install dependencies (npm)
        if: inputs.run-install && inputs.package-manager == 'npm'
        run: npm ci --prefer-offline --no-audit

      - name: Install dependencies (yarn)
        if: inputs.run-install && inputs.package-manager == 'yarn'
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Install dependencies (pnpm)
        if: inputs.run-install && inputs.package-manager == 'pnpm'
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Install dependencies (bun)
        if: inputs.run-install && inputs.package-manager == 'bun'
        run: bun install --frozen-lockfile

      - name: Run linting
        if: inputs.run-lint
        run: ${{ inputs.package-manager }} run lint
        continue-on-error: false

      - name: Run tests
        if: inputs.run-tests
        run: ${{ inputs.package-manager }} run test
        env:
          CI: true

      - name: Run tests with coverage
        if: inputs.run-tests && inputs.coverage
        run: ${{ inputs.package-manager }} run test -- --coverage
        env:
          CI: true

      - name: Upload coverage to Codecov
        if: inputs.coverage
        uses: codecov/codecov-action@7f8b4b4bde536c465e797be725718b88c5d95e0e # v5.1.1
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

      - name: Run build
        if: inputs.run-build
        run: ${{ inputs.package-manager }} run build

      - name: Upload build artifacts
        if: inputs.run-build
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: build-${{ inputs.package-manager }}-node-${{ inputs.node-version }}
          path: |
            ${{ inputs.working-directory }}/dist
            ${{ inputs.working-directory }}/build
            ${{ inputs.working-directory }}/out
          if-no-files-found: ignore
          retention-days: 7
