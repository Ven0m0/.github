# Docker Build & Push Workflow (Reusable)
# Multi-platform builds with SBOM, provenance, and vulnerability scanning


name: Docker Build & Push (Reusable)

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Docker image name (e.g., myorg/myapp)'
        required: true
        type: string
      registry:
        description: 'Container registry: docker.io, ghcr.io, or custom'
        required: false
        type: string
        default: 'docker.io'
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      build-args:
        description: 'Build arguments (newline-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      tags:
        description: 'Additional tags (newline-separated)'
        required: false
        type: string
        default: ''
      push:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      scan-image:
        description: 'Scan image for vulnerabilities with Trivy'
        required: false
        type: boolean
        default: true
      generate-sbom:
        description: 'Generate SBOM with Syft'
        required: false
        type: boolean
        default: true
      provenance:
        description: 'Generate provenance attestation'
        required: false
        type: boolean
        default: true
      cache-to:
        description: 'Cache destination (e.g., type=gha,mode=max)'
        required: false
        type: string
        default: 'type=gha,mode=max'
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 30
    secrets:
      DOCKER_USERNAME:
        description: 'Docker registry username'
        required: false
      DOCKER_PASSWORD:
        description: 'Docker registry password/token'
        required: false

permissions:
  contents: read

jobs:
  docker-build:
    name: Build & Push Docker Image
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29a9e8e8b8b1fa0f8d6fe5e7f1e20b52e08329e9 # v3.3.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8026d2bc3645ea78b0d2544766a1225eb5691f89 # v3.8.0
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to Docker Hub
        if: inputs.push && inputs.registry == 'docker.io'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Container Registry
        if: inputs.push && inputs.registry == 'ghcr.io'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@902fa8bac6fffc3f4a3ab1d0db45888d6b47bae2 # v5.7.0
        with:
          images: ${{ inputs.registry }}/${{ inputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            ${{ inputs.tags }}
          flavor: |
            latest=auto

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@471d1c5d64fbae84f44f22f8c9bf2b210a618b70 # v6.12.0
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          cache-from: type=gha
          cache-to: ${{ inputs.cache-to }}
          provenance: ${{ inputs.provenance }}
          sbom: ${{ inputs.generate-sbom }}
          outputs: type=image,name=${{ inputs.registry }}/${{ inputs.image-name }},push=${{ inputs.push }}

      - name: Generate SBOM with Syft
        if: inputs.generate-sbom
        uses: anchore/sbom-action@56f1a2a27c8eb527eb4ce777e3048f09e8a88e14 # v0.17.12
        with:
          image: ${{ inputs.registry }}/${{ inputs.image-name }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: true
          upload-release-assets: false

      - name: Scan image with Trivy
        if: inputs.scan-image
        uses: aquasecurity/trivy-action@f781cce5aab226378ee181d764ab90ea0be3cdd8 # 0.29.0
        with:
          image-ref: ${{ inputs.registry }}/${{ inputs.image-name }}@${{ steps.build.outputs.digest }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'

      - name: Upload Trivy results to GitHub Security
        if: inputs.scan-image
        uses: github/codeql-action/upload-sarif@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'docker-trivy'

      - name: Scan for critical vulnerabilities
        if: inputs.scan-image
        uses: aquasecurity/trivy-action@f781cce5aab226378ee181d764ab90ea0be3cdd8 # 0.29.0
        with:
          image-ref: ${{ inputs.registry }}/${{ inputs.image-name }}@${{ steps.build.outputs.digest }}
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
          vuln-type: 'os,library'

      - name: Generate artifact attestation
        if: inputs.push && inputs.provenance && inputs.registry == 'ghcr.io'
        uses: actions/attest-build-provenance@e6e03c617df9dc977ee97c9b28f75c9e0c2e04e1 # v2.1.0
        with:
          subject-name: ${{ inputs.registry }}/${{ inputs.image-name }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
