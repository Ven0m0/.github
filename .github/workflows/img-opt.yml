# Image Optimization Workflow (Reusable)
name: Optimize Images (Reusable)

on:
  workflow_call:
    inputs:
      export_webp:
        description: Export images to WebP
        type: boolean
        default: true
        required: false
      export_avif:
        description: Export images to AVIF
        type: boolean
        default: false
        required: false
      replace_original:
        description: Replace original images after conversion
        type: boolean
        default: false
        required: false
      quality:
        description: Output quality (1-100)
        type: number
        default: 85
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  optimize-images:
    name: Optimize Images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.PAT || github.token }}

      - name: Cache Image Tools
        uses: actions/cache@v4
        with:
          path: ~/.cache/image-tools
          key: ${{ runner.os }}-image-tools-v1

      - name: Find Images
        id: find-images
        run: |
          set -euo pipefail; shopt -s nullglob globstar
          # Efficiently find images excluding standard ignore dirs
          mapfile -t images < <(
            find . -type f \( -iname '*.gif' -o -iname '*.svg' -o \
              -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \
            \) -not -path '*/.git/*' -not -path '*/node_modules/*' -not -path '*/.cache/*'
          )
          count=${#images[@]}
          echo "image_count=$count" >> "$GITHUB_OUTPUT"
          
          if [[ $count -gt 0 ]]; then
            echo "## üñºÔ∏è Images Found" >> "$GITHUB_STEP_SUMMARY"
            echo "Found **$count** images to process." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No images found to process."
          fi

      - name: Compress and Convert
        id: compress
        if: steps.find-images.outputs.image_count > 0
        uses: stellasoftio/image-optimizer-action@v2
        with:
          github-token: ${{ secrets.PAT || github.token }}
          export-webp: ${{ inputs.export_webp }}
          export-avif: ${{ inputs.export_avif }}
          compress-png: true
          compress-svg: true
          compress-jpg: true
          compress-webp: true
          compress-avif: true
          replace-original-after-export-webp: ${{ inputs.replace_original }}
          webp-quality: ${{ inputs.quality }}
          avif-quality: ${{ inputs.quality }}

      - name: Remove Originals
        if: steps.compress.outputs.changes_detected == 'true' && inputs.replace_original
        run: |
          set -euo pipefail; shopt -s nullglob globstar
          removed=0
          
          # Helper function to remove
          remove_base_ext() {
            local base="$1"
            for ext in png jpg jpeg gif; do
              if [[ -f "${base}.${ext}" ]]; then
                rm -v "${base}.${ext}"
                removed=$((removed + 1))
              fi
            done
          }

          [[ "${{ inputs.export_avif }}" == "true" ]] && for f in **/*.avif; do remove_base_ext "${f%.avif}"; done
          [[ "${{ inputs.export_webp }}" == "true" ]] && for f in **/*.webp; do remove_base_ext "${f%.webp}"; done

          echo "## üóëÔ∏è Originals Removed" >> "$GITHUB_STEP_SUMMARY"
          echo "Removed **$removed** original files." >> "$GITHUB_STEP_SUMMARY"

      - name: Calculate Savings & Commit
        if: steps.compress.outputs.changes_detected == 'true'
        id: savings
        run: |
          set -euo pipefail
          
          # Calculate stats from git diff (approximate but fast)
          added=$(git diff --numstat | awk '{s+=$1} END {print s+0}')
          deleted=$(git diff --numstat | awk '{s+=$2} END {print s+0}')
          
          # If we deleted more than added (or replaced big with small)
          if [[ $deleted -gt 0 ]]; then
             pct=$(awk "BEGIN {printf \"%.1f\", (($deleted - $added) / $deleted) * 100}")
             echo "savings_percent=$pct" >> "$GITHUB_OUTPUT"
             
             echo "## üìä Optimization Results" >> "$GITHUB_STEP_SUMMARY"
             echo "- **Space impact**: $pct% reduction (approx)" >> "$GITHUB_STEP_SUMMARY"
             echo "- **Files touched**: $(git diff --name-only | wc -l)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Commit and Push
        if: >-
          steps.compress.outputs.changes_detected == 'true' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(img): optimize images [skip ci]"
          branch: ${{ github.head_ref || github.ref_name }}
          commit_user_name: image-optimizer-bot[bot]
          commit_user_email: image-optimizer-bot[bot]@users.noreply.github.com
          file_pattern: "*.png *.jpg *.jpeg *.gif *.svg *.webp *.avif"

      - name: Comment on PR
        if: >-
          steps.compress.outputs.changes_detected == 'true' &&
          github.event_name == 'pull_request' &&
          steps.savings.outputs.savings_percent != ''
        uses: actions/github-script@v7
        with:
          script: |-
            const savings = '${{ steps.savings.outputs.savings_percent }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üñºÔ∏è Image Optimization Complete\n\n- **Space saved**: ~${savings}%\n- **Status**: Images processed successfully`
            });
