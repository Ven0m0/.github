# Reusable Security Scanning Workflow
# Includes: CodeQL SAST, Trivy vulnerability scanning, Dependency Review, Snyk (optional)

name: Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      language:
        description: 'CodeQL language: javascript, typescript, python, go, java, etc.'
        required: false
        type: string
        default: 'javascript'
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      run-codeql:
        description: 'Run CodeQL SAST analysis'
        required: false
        type: boolean
        default: true
      run-trivy:
        description: 'Run Trivy vulnerability scanner'
        required: false
        type: boolean
        default: true
      run-dependency-review:
        description: 'Run dependency review (PR only)'
        required: false
        type: boolean
        default: true
      run-snyk:
        description: 'Run Snyk security scan (requires SNYK_TOKEN)'
        required: false
        type: boolean
        default: false
      trivy-scan-type:
        description: 'Trivy scan type: fs, repo, or config'
        required: false
        type: string
        default: 'fs'
      trivy-severity:
        description: 'Trivy severity filter (CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN)'
        required: false
        type: string
        default: 'CRITICAL,HIGH'
      fail-on-severity:
        description: 'Fail build on vulnerabilities at or above this severity'
        required: false
        type: string
        default: 'CRITICAL'
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 20
    secrets:
      SNYK_TOKEN:
        description: 'Snyk authentication token (required if run-snyk is true)'
        required: false

permissions:
  contents: read

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    if: inputs.run-codeql
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      security-events: write
      actions: read

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Initialize CodeQL
        uses: github/codeql-action/init@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9
        with:
          languages: ${{ inputs.language }}
          queries: +security-extended,security-and-quality
          config: |
            paths-ignore:
              - '**/node_modules'
              - '**/dist'
              - '**/build'
              - '**/.venv'
              - '**/venv'
              - '**/vendor'

      - name: Autobuild
        uses: github/codeql-action/autobuild@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9
        with:
          category: "/language:${{ inputs.language }}"
          upload: true

  trivy-scan:
    name: Trivy Vulnerability Scan
    if: inputs.run-trivy
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@f781cce5aab226378ee181d764ab90ea0be3cdd8 # 0.29.0
        with:
          scan-type: ${{ inputs.trivy-scan-type }}
          scan-ref: ${{ inputs.working-directory }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ inputs.trivy-severity }}
          exit-code: '0'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: Run Trivy with fail on severity
        uses: aquasecurity/trivy-action@f781cce5aab226378ee181d764ab90ea0be3cdd8 # 0.29.0
        with:
          scan-type: ${{ inputs.trivy-scan-type }}
          scan-ref: ${{ inputs.working-directory }}
          format: 'table'
          severity: ${{ inputs.fail-on-severity }}
          exit-code: '1'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'

  dependency-review:
    name: Dependency Review
    if: inputs.run-dependency-review && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@4081bf99e2866ebe428fc0477b69eb4fcda7220a # v4.4.0
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0
          comment-summary-in-pr: always
          warn-only: false

  snyk-scan:
    name: Snyk Security Scan
    if: inputs.run-snyk
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif --severity-threshold=high

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@48d47745fc8a36e27cd91067236e3ed03299a3eb # v3.27.9
        with:
          sarif_file: snyk.sarif
          category: 'snyk'
