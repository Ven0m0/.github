# Reusable Python CI Workflow
# Supports: pip, uv, poetry
#
# Required secrets: none (unless publishing)
# Optional secrets:
#   - PYPI_TOKEN: for package publishing
#   - CODECOV_TOKEN: for code coverage uploads
#
# Usage example:
# jobs:
#   test:
#     uses: Ven0m0/.github/.github/workflows/python-ci.yml@main
#     with:
#       python-version: '3.12'
#       package-manager: 'uv'
#       run-tests: true

name: Python CI (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use (supports matrix as JSON array)'
        required: false
        type: string
        default: '3.12'
      package-manager:
        description: 'Package manager: pip, uv, or poetry'
        required: false
        type: string
        default: 'pip'
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'
      run-install:
        description: 'Run package installation'
        required: false
        type: boolean
        default: true
      run-lint:
        description: 'Run linting with ruff/flake8'
        required: false
        type: boolean
        default: true
      run-format-check:
        description: 'Check formatting with ruff/black'
        required: false
        type: boolean
        default: true
      run-type-check:
        description: 'Run type checking with mypy'
        required: false
        type: boolean
        default: false
      run-tests:
        description: 'Run tests with pytest'
        required: false
        type: boolean
        default: true
      coverage:
        description: 'Generate and upload code coverage'
        required: false
        type: boolean
        default: false
      requirements-file:
        description: 'Path to requirements file'
        required: false
        type: string
        default: 'requirements.txt'
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 15
    secrets:
      PYPI_TOKEN:
        description: 'PyPI authentication token (optional)'
        required: false
      CODECOV_TOKEN:
        description: 'Codecov upload token (optional)'
        required: false

permissions:
  contents: read

jobs:
  python-ci:
    name: Python ${{ inputs.python-version }} (${{ inputs.package-manager }})
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ inputs.python-version }}
          cache: ${{ inputs.package-manager == 'poetry' && 'poetry' || 'pip' }}
          cache-dependency-path: |
            ${{ inputs.working-directory }}/requirements*.txt
            ${{ inputs.working-directory }}/pyproject.toml
            ${{ inputs.working-directory }}/poetry.lock
            ${{ inputs.working-directory }}/uv.lock

      - name: Install uv
        if: inputs.package-manager == 'uv'
        uses: astral-sh/setup-uv@3e91c41d67cacd95c3d2fd9f39e4d107f97efe12 # v5.1.2
        with:
          enable-cache: true
          cache-dependency-glob: |
            ${{ inputs.working-directory }}/requirements*.txt
            ${{ inputs.working-directory }}/pyproject.toml
            ${{ inputs.working-directory }}/uv.lock

      - name: Install Poetry
        if: inputs.package-manager == 'poetry'
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a # v1.4.1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Upgrade pip
        if: inputs.package-manager == 'pip'
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies (pip)
        if: inputs.run-install && inputs.package-manager == 'pip'
        run: |
          if [ -f "${{ inputs.requirements-file }}" ]; then
            pip install -r ${{ inputs.requirements-file }}
          elif [ -f "pyproject.toml" ]; then
            pip install -e .
          fi

      - name: Install dependencies (uv)
        if: inputs.run-install && inputs.package-manager == 'uv'
        run: |
          if [ -f "${{ inputs.requirements-file }}" ]; then
            uv pip install --system -r ${{ inputs.requirements-file }}
          elif [ -f "pyproject.toml" ]; then
            uv pip install --system -e .
          fi

      - name: Install dependencies (poetry)
        if: inputs.run-install && inputs.package-manager == 'poetry'
        run: poetry install --no-interaction --no-root

      - name: Install project (poetry)
        if: inputs.run-install && inputs.package-manager == 'poetry'
        run: poetry install --no-interaction

      - name: Run linting with ruff
        if: inputs.run-lint
        run: |
          if command -v ruff &> /dev/null; then
            ruff check .
          elif ${{ inputs.package-manager == 'poetry' }} && poetry run ruff --version &> /dev/null; then
            poetry run ruff check .
          else
            echo "Ruff not found, skipping lint"
          fi
        continue-on-error: false

      - name: Run format check with ruff
        if: inputs.run-format-check
        run: |
          if command -v ruff &> /dev/null; then
            ruff format --check .
          elif ${{ inputs.package-manager == 'poetry' }} && poetry run ruff --version &> /dev/null; then
            poetry run ruff format --check .
          else
            echo "Ruff not found, skipping format check"
          fi
        continue-on-error: false

      - name: Run type checking with mypy
        if: inputs.run-type-check
        run: |
          if command -v mypy &> /dev/null; then
            mypy .
          elif ${{ inputs.package-manager == 'poetry' }} && poetry run mypy --version &> /dev/null; then
            poetry run mypy .
          else
            echo "Mypy not found, skipping type check"
          fi
        continue-on-error: false

      - name: Run tests with pytest
        if: inputs.run-tests && !inputs.coverage
        run: |
          if ${{ inputs.package-manager == 'poetry' }}; then
            poetry run pytest
          else
            pytest
          fi
        env:
          CI: true

      - name: Run tests with coverage
        if: inputs.run-tests && inputs.coverage
        run: |
          if ${{ inputs.package-manager == 'poetry' }}; then
            poetry run pytest --cov --cov-report=xml --cov-report=term
          else
            pytest --cov --cov-report=xml --cov-report=term
          fi
        env:
          CI: true

      - name: Upload coverage to Codecov
        if: inputs.coverage
        uses: codecov/codecov-action@7f8b4b4bde536c465e797be725718b88c5d95e0e # v5.1.1
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
