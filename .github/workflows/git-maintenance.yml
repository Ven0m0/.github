# Git Maintenance & Cleanup (Reusable Workflow)

name: Git Maintenance & Cleanup (Reusable)

on:
  workflow_call:
    inputs:
      run_gc:
        description: 'Run git garbage collection'
        type: boolean
        default: true
        required: false
      run_prune:
        description: 'Prune unreachable objects'
        type: boolean
        default: true
        required: false
      prune_expire:
        description: 'Expiration time for pruning'
        type: string
        default: '2.weeks.ago'
        required: false
      optimize_repo:
        description: 'Run repository optimization'
        type: boolean
        default: true
        required: false
      verify_integrity:
        description: 'Verify repository integrity'
        type: boolean
        default: true
        required: false
      aggressive_gc:
        description: 'Use aggressive garbage collection'
        type: boolean
        default: false
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  maintenance:
    name: Git Repository Maintenance
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    outputs:
      size_before: ${{ steps.stats-before.outputs.repo_size }}
      size_after: ${{ steps.stats-after.outputs.repo_size }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || github.token }}

      - name: Repository Statistics (Before)
        id: stats-before
        run: |
          set -euo pipefail
          echo "## Repository Statistics (Before Maintenance)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          stats=$(git count-objects -v)
          echo "$stats" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          size=$(echo "$stats" | grep 'size-pack:' | awk '{print $2}')
          echo "repo_size=${size:-0}" >> "$GITHUB_OUTPUT"

      - name: Verify Repository Integrity
        if: inputs.verify_integrity
        run: |
          set -euo pipefail
          echo "## Repository Integrity Check" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          git fsck --full --no-progress 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || echo "Integrity issues detected"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Prune Unreachable Objects
        if: inputs.run_prune
        run: |
          set -euo pipefail
          echo "## Pruning Objects (older than ${{ inputs.prune_expire }})" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          git prune --expire="${{ inputs.prune_expire }}" --progress 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || echo "No objects to prune"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Run Garbage Collection
        if: inputs.run_gc
        run: |
          set -euo pipefail
          gc_mode=$([[ "${{ inputs.aggressive_gc }}" == "true" ]] && echo "aggressive" || echo "standard")
          echo "## Garbage Collection ($gc_mode)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          gc_flags="--prune=now"
          [[ "${{ inputs.aggressive_gc }}" == "true" ]] && gc_flags="$gc_flags --aggressive"
          git gc $gc_flags 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Optimize Repository
        if: inputs.optimize_repo
        run: |
          set -euo pipefail
          echo "## Repository Optimization" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          git maintenance run --task=loose-objects --task=incremental-repack 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || true
          git repack -a -d --depth=250 --window=250 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Repository Statistics (After)
        id: stats-after
        if: always()
        run: |
          set -euo pipefail
          echo "## Repository Statistics (After Maintenance)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          stats=$(git count-objects -v)
          echo "$stats" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          size=$(echo "$stats" | grep 'size-pack:' | awk '{print $2}')
          echo "repo_size=${size:-0}" >> "$GITHUB_OUTPUT"
          
          # Calculate savings
          before="${{ steps.stats-before.outputs.repo_size }}"
          after="${size:-0}"
          if [[ $before -gt 0 && $after -gt 0 ]]; then
            diff=$((before - after))
            if [[ $diff -gt 0 ]]; then
              pct=$(awk "BEGIN {printf \"%.1f\", ($diff / $before) * 100}")
              echo "âœ… Size reduced by ${diff} KiB (${pct}%)" >> "$GITHUB_STEP_SUMMARY"
            elif [[ $diff -lt 0 ]]; then
              echo "ðŸ“ˆ Size increased by $((-diff)) KiB" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âž¡ï¸ Size unchanged" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Maintenance Summary
        if: always()
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## Maintenance Summary
          
          | Task | Status |
          |------|--------|
          | Repository statistics | âœ… |
          | Integrity verification | $([ "${{ inputs.verify_integrity }}" = "true" ] && echo "âœ…" || echo "â­ï¸") |
          | Prune unreachable objects | $([ "${{ inputs.run_prune }}" = "true" ] && echo "âœ…" || echo "â­ï¸") |
          | Garbage collection | $([ "${{ inputs.run_gc }}" = "true" ] && echo "âœ…" || echo "â­ï¸") |
          | Repository optimization | $([ "${{ inputs.optimize_repo }}" = "true" ] && echo "âœ…" || echo "â­ï¸") |
          
          ---
          ðŸ”— [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
