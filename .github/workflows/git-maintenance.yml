# Git Maintenance & Cleanup + Submodules Update (Reusable)
name: Git Maintenance & Submodules (Reusable)

on:
  workflow_call:
    inputs:
      run_gc:
        type: boolean
        default: true
        description: 'Run git garbage collection'
      optimize_repo:
        type: boolean
        default: true
        description: 'Optimize repository (commit-graph, loose-objects, repack)'
      verify_integrity:
        type: boolean
        default: true
        description: 'Verify repository integrity with fsck'
      strategy:
        type: string
        default: commit
        description: 'Submodule update strategy (commit, branch, tag)'
      submodules:
        type: string
        default: ""
        description: 'Space-separated list of submodules to update (empty = all)'
      gitmodules_path:
        type: string
        default: .gitmodules
        description: 'Path to .gitmodules file'
      create_pr:
        type: boolean
        default: true
        description: 'Create pull request for submodule updates'
      pr_branch_prefix:
        type: string
        default: chore/update-submodules
        description: 'Branch prefix for submodule update PRs'
      commit_message:
        type: string
        default: "chore(deps): update git submodules"
        description: 'Commit message for submodule updates'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
jobs:
  maintenance:
    name: Git Maintenance & Submodules
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.PAT || github.token }}

      - name: Update Submodules
        id: submodules
        uses: sgoudham/update-git-submodules@v2
        with:
          gitmodulesPath: ${{ inputs.gitmodules_path }}
          strategy: ${{ inputs.strategy }}
          submodules: ${{ inputs.submodules }}

      - name: Create Pull Request for Submodule Updates
        if: inputs.create_pr && steps.submodules.outputs.json != '' && steps.submodules.outputs.json != '[]'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.PAT || github.token }}
          commit-message: ${{ inputs.commit_message }}
          branch: ${{ inputs.pr_branch_prefix }}-${{ github.run_id }}
          title: ${{ inputs.commit_message }}
          body: |
            ## Submodule Updates
            ${{ steps.submodules.outputs.prBody }}
          labels: dependencies,automated
      - name: Run Git Maintenance
        shell: bash
        run: |
          set -euo pipefail

          # Helper functions
          get_stats() {
            git count-objects -v
          }

          get_pack_size() {
            awk '/size-pack:/ {print $2}'
          }

          # Capture stats before maintenance
          before_size=$(get_stats | get_pack_size)

          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Repository Stats (Before)
          ```
          EOF
          get_stats >> "$GITHUB_STEP_SUMMARY"
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ```
          EOF

          # Verify repository integrity
          if [[ "${{ inputs.verify_integrity }}" == "true" ]]; then
            echo "## Integrity Check" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            if git fsck --full --no-progress 2>&1 >> "$GITHUB_STEP_SUMMARY"; then
              echo "âœ… No issues detected" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ Issues detected" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

          # Build maintenance task list
          tasks=()
          if [[ "${{ inputs.optimize_repo }}" == "true" ]]; then
            tasks+=(--task=commit-graph --task=loose-objects --task=incremental-repack)
          fi
          if [[ "${{ inputs.run_gc }}" == "true" ]]; then
            tasks+=(--task=gc)
          fi

          # Run maintenance tasks
          if [[ ${#tasks[@]} -gt 0 ]]; then
            echo "## Maintenance Tasks" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            git maintenance run "${tasks[@]}" 2>&1 >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

          # Capture stats after maintenance
          after_size=$(get_stats | get_pack_size)

          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Repository Stats (After)
          ```
          EOF
          get_stats >> "$GITHUB_STEP_SUMMARY"
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ```
          EOF

          # Calculate and display size difference
          if [[ $before_size -gt 0 && $after_size -gt 0 ]]; then
            diff=$((before_size - after_size))
            if [[ $diff -gt 0 ]]; then
              pct=$(awk "BEGIN {printf \"%.1f\", ($diff / $before_size) * 100}")
              echo "âœ… Reduced by ${diff}KB (${pct}%)" >> "$GITHUB_STEP_SUMMARY"
            elif [[ $diff -lt 0 ]]; then
              echo "ðŸ“ˆ Increased by $((-diff))KB" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âž¡ï¸ Unchanged" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
