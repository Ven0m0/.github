# Git Maintenance & Cleanup + Submodules Update (Reusable)
name: Git Maintenance & Submodules (Reusable)
on:
  workflow_call:
    inputs:
      run_gc:
        type: boolean
        default: true
      optimize_repo:
        type: boolean
        default: true
      verify_integrity:
        type: boolean
        default: true
      strategy:
        type: string
        default: commit
      submodules:
        type: string
        default: ""
      gitmodules_path:
        type: string
        default: .gitmodules
      create_pr:
        type: boolean
        default: true
      pr_branch_prefix:
        type: string
        default: chore/update-submodules
      commit_message:
        type: string
        default: "chore(deps): update git submodules"
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: false
permissions:
  contents: write
  pull-requests: write
jobs:
  maintenance:
    name: Git Maintenance & Submodules
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.PAT || github.token }}
      - name: Update Submodules
        id: submodules
        uses: sgoudham/update-git-submodules@v2
        with:
          gitmodulesPath: ${{ inputs.gitmodules_path }}
          strategy: ${{ inputs.strategy }}
          submodules: ${{ inputs.submodules }}
      - name: Create PR (Submodules)
        if: inputs.create_pr && steps.submodules.outputs.json != '' && steps.submodules.outputs.json != '[]'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.PAT || github.token }}
          commit-message: ${{ inputs.commit_message }}
          branch: ${{ inputs.pr_branch_prefix }}-${{ github.run_id }}
          title: ${{ inputs.commit_message }}
          body: |
            ## Submodule Updates
            ${{ steps.submodules.outputs.prBody }}
          labels: dependencies,automated
      - name: Stats & Maintenance
        run: |
          #!/usr/bin/env bash
          set -euo pipefail
          stats(){ git count-objects -v; }
          get_size(){ awk '/size-pack:/ {print $2}'; }
          before=$(stats | get_size)
          cat >>"$GITHUB_STEP_SUMMARY" <<EOF
          ## Repository Stats (Before)
          \`\`\`
          $(stats)
          \`\`\`
          EOF
          [[ "${{ inputs.verify_integrity }}" == "true" ]] && {
            echo "## Integrity Check" >>"$GITHUB_STEP_SUMMARY"
            echo '```' >>"$GITHUB_STEP_SUMMARY"
            git fsck --full --no-progress 2>&1 >>"$GITHUB_STEP_SUMMARY" || echo "Issues detected" >>"$GITHUB_STEP_SUMMARY"
            echo '```' >>"$GITHUB_STEP_SUMMARY"
          }
          tasks=()
          [[ "${{ inputs.optimize_repo }}" == "true" ]] && tasks+=(--task=commit-graph --task=loose-objects --task=incremental-repack)
          [[ "${{ inputs.run_gc }}" == "true" ]] && tasks+=(--task=gc)
          [[ ${#tasks[@]} -gt 0 ]] && {
            echo "## Maintenance" >>"$GITHUB_STEP_SUMMARY"
            echo '```' >>"$GITHUB_STEP_SUMMARY"
            git maintenance run "${tasks[@]}" 2>&1 >>"$GITHUB_STEP_SUMMARY"
            echo '```' >>"$GITHUB_STEP_SUMMARY"
          }
          after=$(stats | get_size)
          cat >>"$GITHUB_STEP_SUMMARY" <<EOF
          ## Stats (After)
          \`\`\`
          $(stats)
          \`\`\`
          EOF
          [[ $before -gt 0 && $after -gt 0 ]] && {
            diff=$((before - after))
            [[ $diff -gt 0 ]] && pct=$(awk "BEGIN {printf \"%.1f\", ($diff / $before) * 100}") && echo "âœ… Reduced by ${diff}KB (${pct}%)" >>"$GITHUB_STEP_SUMMARY"
            [[ $diff -lt 0 ]] && echo "ðŸ“ˆ Increased by $((-diff))KB" >>"$GITHUB_STEP_SUMMARY"
            [[ $diff -eq 0 ]] && echo "âž¡ï¸ Unchanged" >>"$GITHUB_STEP_SUMMARY"
          }
