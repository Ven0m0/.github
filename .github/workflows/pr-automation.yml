# Pull Request Automation Workflow (Reusable)
# Features: Auto-labeling, size checking, conflict detection, optional auto-assignment

name: PR Automation (Reusable)

on:
  workflow_call:
    inputs:
      enable-auto-label:
        description: 'Enable automatic PR labeling based on files changed'
        type: boolean
        required: false
        default: true
      enable-size-label:
        description: 'Add size labels based on lines changed'
        type: boolean
        required: false
        default: true
      enable-conflict-check:
        description: 'Check for merge conflicts'
        type: boolean
        required: false
        default: true
      enable-auto-assign:
        description: 'Auto-assign reviewers'
        type: boolean
        required: false
        default: false
      enable-conventional-commits:
        description: 'Validate conventional commit format'
        type: boolean
        required: false
        default: false
      enable-checklist:
        description: 'Validate PR checklist completion'
        type: boolean
        required: false
        default: false
      size-xs-lines:
        description: 'Max lines for XS size'
        type: number
        required: false
        default: 10
      size-s-lines:
        description: 'Max lines for S size'
        type: number
        required: false
        default: 100
      size-m-lines:
        description: 'Max lines for M size'
        type: number
        required: false
        default: 500
      size-l-lines:
        description: 'Max lines for L size'
        type: number
        required: false
        default: 1000
      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        required: false
        default: 10

permissions:
  contents: read

jobs:
  auto-label:
    name: Auto Label PR
    if: inputs.enable-auto-label && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Label PR based on changed files
        uses: actions/labeler@8558fd74291d67161a8a78ce36a881fa63b766a9 # v5.0.0
        with:
          configuration-path: .github/labeler.yml
          sync-labels: true

  size-label:
    name: Add Size Label
    if: inputs.enable-size-label && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Add size label
        uses: codelytv/pr-size-labeler@f4ba2e2f0c5d8306acfb8f2b4a4dec06eef2d6e3 # v1.10.1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: ${{ inputs.size-xs-lines }}
          s_label: 'size/S'
          s_max_size: ${{ inputs.size-s-lines }}
          m_label: 'size/M'
          m_max_size: ${{ inputs.size-m-lines }}
          l_label: 'size/L'
          l_max_size: ${{ inputs.size-l-lines }}
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: 'This PR is very large. Consider breaking it into smaller PRs.'
          files_to_ignore: |
            package-lock.json
            yarn.lock
            pnpm-lock.yaml
            bun.lockb
            poetry.lock
            Pipfile.lock
            go.sum
            Cargo.lock

  conflict-check:
    name: Check for Conflicts
    if: inputs.enable-conflict-check && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Check for merge conflicts
        uses: eps1lon/actions-label-merge-conflict@b5e96152f0dc1ce8b6277f065121c875a7d7a382 # v3.0.2
        with:
          dirtyLabel: 'merge-conflict'
          removeOnDirtyLabel: 'ready-to-merge'
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          continueOnMissingPermissions: false

  conventional-commits:
    name: Validate Conventional Commits
    if: inputs.enable-conventional-commits && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check PR title follows Conventional Commits
        uses: amannn/action-semantic-pull-request@0723387faaf9b38adef4775cd42cfd5155ed6017 # v5.5.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.
          validateSingleCommit: false
          ignoreLabels: |
            ignore-semantic-pr

  checklist-validator:
    name: Validate PR Checklist
    if: inputs.enable-checklist && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Check PR body for checklist items
        uses: zvictor/checklist-validator@8a11e071a47f48ac8e71b7e53f3c5e06f6ce31fb # v2.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ignore-pattern: '<!-- .* -->'

  auto-assign:
    name: Auto Assign Reviewers
    if: inputs.enable-auto-assign && github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Auto assign reviewers
        uses: kentaro-m/auto-assign-action@f5d904c8f9de8fc5a9b7aba34f44ea600bb0434b # v2.0.0
        with:
          configuration-path: '.github/auto-assign.yml'
