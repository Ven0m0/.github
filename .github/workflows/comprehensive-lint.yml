# Comprehensive Linting Workflow (Reusable)
# Consolidated from: lint.yml, shell-lint.yml, unified-linters.yml
# Supports: ESLint, Prettier, Ruff, Black, mypy, actionlint, yamllint, markdownlint,
#           ShellCheck, shellharden, shfmt, MegaLinter, Reviewdog
#
# Required secrets: none (GITHUB_TOKEN automatically provided)
# Optional secrets:
#   - PAT: Personal Access Token with repo scope for enhanced permissions
#
# Usage example:
# jobs:
#   lint:
#     uses: Ven0m0/.github/.github/workflows/comprehensive-lint.yml@main
#     with:
#       run-eslint: true
#       run-prettier: true
#       run-shellcheck: true
#       apply-shell-fixes: true

name: Comprehensive Lint (Reusable)

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the project'
        required: false
        type: string
        default: '.'

      # JavaScript/TypeScript linting
      run-eslint:
        description: 'Run ESLint for JavaScript/TypeScript'
        required: false
        type: boolean
        default: false
      run-prettier:
        description: 'Run Prettier format check'
        required: false
        type: boolean
        default: false
      eslint-extensions:
        description: 'File extensions for ESLint (e.g., "js,ts,jsx,tsx")'
        required: false
        type: string
        default: 'js,ts,jsx,tsx'

      # Python linting
      run-ruff:
        description: 'Run Ruff for Python'
        required: false
        type: boolean
        default: false
      run-black:
        description: 'Run Black for Python'
        required: false
        type: boolean
        default: false
      run-mypy:
        description: 'Run mypy for Python type checking'
        required: false
        type: boolean
        default: false

      # Shell linting
      run-shellcheck:
        description: 'Run ShellCheck for shell scripts'
        required: false
        type: boolean
        default: false
      run-shellcheck-reviewdog:
        description: 'Run ShellCheck via Reviewdog for PR comments'
        required: false
        type: boolean
        default: false
      apply-shell-fixes:
        description: 'Apply automatic shell fixes (shellharden + shfmt + shellcheck patches)'
        required: false
        type: boolean
        default: false
      shellcheck-severity:
        description: 'Minimum severity level for ShellCheck (error, warning, info, style)'
        required: false
        type: string
        default: 'warning'
      shfmt-indent:
        description: 'Number of spaces for shfmt indentation'
        required: false
        type: number
        default: 2
      shell-exclude-pattern:
        description: 'Regex pattern to exclude files/directories from shell linting'
        required: false
        type: string
        default: '(^|/)\\.(git|cache|claude)(/|$)'

      # Other linters
      run-actionlint:
        description: 'Run actionlint for GitHub Actions workflows'
        required: false
        type: boolean
        default: true
      run-yamllint:
        description: 'Run yamllint for YAML files'
        required: false
        type: boolean
        default: false
      run-markdownlint:
        description: 'Run markdownlint for Markdown files'
        required: false
        type: boolean
        default: false

      # MegaLinter
      run-megalinter:
        description: 'Run MegaLinter (comprehensive multi-language linting)'
        required: false
        type: boolean
        default: false
      megalinter-validate-all:
        description: 'Validate entire codebase (not just diff) with MegaLinter'
        required: false
        type: boolean
        default: false
      megalinter-apply-fixes:
        description: 'Apply MegaLinter automatic fixes'
        required: false
        type: boolean
        default: false
      megalinter-config:
        description: 'Path to MegaLinter config file'
        required: false
        type: string
        default: '.megalinter.yml'
      megalinter-exclude-dirs:
        description: 'Directories to exclude from MegaLinter (comma-separated)'
        required: false
        type: string
        default: '.github,.git,.cache,node_modules'

      # General settings
      commit-fixes:
        description: 'Commit and push automatic fixes'
        required: false
        type: boolean
        default: false
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 15

permissions:
  contents: read

env:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C

jobs:
  # JavaScript/TypeScript + Python + General linting
  lint-code:
    name: Lint Code
    if: |
      inputs.run-eslint || inputs.run-prettier || inputs.run-ruff ||
      inputs.run-black || inputs.run-mypy || inputs.run-actionlint ||
      inputs.run-yamllint || inputs.run-markdownlint
    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout-minutes }}

    permissions:
      contents: read
      pull-requests: write

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      # JavaScript/TypeScript setup
      - name: Setup Node.js
        if: inputs.run-eslint || inputs.run-prettier
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        if: inputs.run-eslint || inputs.run-prettier
        run: npm ci --prefer-offline --no-audit

      - name: Run ESLint
        if: inputs.run-eslint
        run: npx eslint . --ext ${{ inputs.eslint-extensions }} --max-warnings 0
        continue-on-error: false

      - name: Run Prettier check
        if: inputs.run-prettier
        run: npx prettier --check .
        continue-on-error: false

      # Python setup
      - name: Setup Python
        if: inputs.run-ruff || inputs.run-black || inputs.run-mypy
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: Install Python linting tools
        if: inputs.run-ruff || inputs.run-black || inputs.run-mypy
        run: |
          pip install --upgrade pip
          pip install ruff black mypy

      - name: Run Ruff check
        if: inputs.run-ruff
        run: ruff check .
        continue-on-error: false

      - name: Run Ruff format check
        if: inputs.run-ruff
        run: ruff format --check .
        continue-on-error: false

      - name: Run Black check
        if: inputs.run-black
        run: black --check .
        continue-on-error: false

      - name: Run mypy
        if: inputs.run-mypy
        run: mypy .
        continue-on-error: false

      # Other linters
      - name: Run actionlint
        if: inputs.run-actionlint
        uses: reviewdog/action-actionlint@67088c66ad19d797e3c45f86fce88fae5ebdf5e2 # v1.60.0
        with:
          level: error
          reporter: github-check
          fail_on_error: true

      - name: Run yamllint
        if: inputs.run-yamllint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3.1.1
        with:
          file_or_dir: .
          config_file: .yamllint.yml
          strict: true
          no_warnings: true

      - name: Run markdownlint
        if: inputs.run-markdownlint
        uses: DavidAnson/markdownlint-cli2-action@db43aef879112c3119a410d69f66701e0d530809 # v18.0.0
        with:
          globs: '**/*.md'
          fix: false

  # ShellCheck basic linting
  shellcheck-lint:
    name: ShellCheck Lint
    if: inputs.run-shellcheck
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@00b27aa7cb85167568cb48a3838b75f4265f2bca # 2.0.0
        with:
          scandir: ${{ inputs.working-directory }}
          severity: ${{ inputs.shellcheck-severity }}
          check_together: 'yes'

  # ShellCheck with Reviewdog (PR comments)
  shellcheck-reviewdog:
    name: ShellCheck (Reviewdog)
    if: inputs.run-shellcheck-reviewdog && github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Run ShellCheck via Reviewdog
        uses: reviewdog/action-shellcheck@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          level: ${{ inputs.shellcheck-severity }}
          path: ${{ inputs.working-directory }}
          pattern: |
            *.sh
            *.bash
            .bashrc
            bash_*
          exclude: '*/.git/*,*/.cache/*,*/.claude/*,*/node_modules/*'
          check_all_files_with_shebangs: 'true'
          shellcheck_flags: '-x -s bash -S ${{ inputs.shellcheck-severity }}'

  # Shell auto-fix (shellharden + shfmt + shellcheck patches)
  shell-auto-fix:
    name: Shell Auto-Fix
    if: inputs.apply-shell-fixes
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Cache shell tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/shellharden
            /usr/local/bin/shfmt
          key: ${{ runner.os }}-shell-tools-v2

      - name: Install shellharden
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -sfL https://github.com/anordal/shellharden/releases/latest/download/shellharden-x86_64-unknown-linux-gnu.tar.gz | \
            sudo tar xz -C /usr/local/bin shellharden

      - name: Install shfmt
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -sfL https://github.com/mvdan/sh/releases/latest/download/shfmt_v3.10.0_linux_amd64 -o /tmp/shfmt
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Find shell files
        id: find-files
        env:
          EXCLUDE_PATTERN: ${{ inputs.shell-exclude-pattern }}
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          mapfile -t files < <(
            {
              find . -type f \( -name '*.sh' -o -name '*.bash' -o -name '*bashrc' -o -name '*profile' -o -name 'bash_*' \)
              find . -type f -executable -exec sh -c 'head -n1 "$1" | grep -qE "^#!/.*(bash|sh)"' _ {} \; -print
            } | grep -vE "$EXCLUDE_PATTERN" | sort -u
          )
          echo "file_count=${#files[@]}" >> "$GITHUB_OUTPUT"
          printf '%s\n' "${files[@]}" > /tmp/shell_files.txt
          {
            echo "## Shell Files Found"
            echo "Found ${#files[@]} shell files"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Apply fixes
        if: steps.find-files.outputs.file_count > 0
        env:
          SHELLCHECK_OPTS: --source-path=SCRIPTDIR --external-sources --check-sourced --shell=bash --severity=${{ inputs.shellcheck-severity }}
          SHFMT_INDENT: ${{ inputs.shfmt-indent }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          shellharden_count=0
          shellcheck_count=0
          shfmt_count=0

          while IFS= read -r file; do
            echo "Processing: $file"
            # shellharden
            if shellharden --replace "$file" 2>/dev/null; then
              shellharden_count=$((shellharden_count + 1))
            fi
            # shellcheck patches
            if shellcheck -f diff "$file" 2>/dev/null | patch -Np1 2>/dev/null; then
              shellcheck_count=$((shellcheck_count + 1))
            fi
            # shfmt
            if shfmt -i "${SHFMT_INDENT}" -s -ln bash -bn -ci -w "$file" 2>/dev/null; then
              shfmt_count=$((shfmt_count + 1))
            fi
          done < /tmp/shell_files.txt

          {
            echo "## Formatting Summary"
            echo "- **shellharden**: $shellharden_count files"
            echo "- **shellcheck patches**: $shellcheck_count files"
            echo "- **shfmt**: $shfmt_count files"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Commit and push fixes
        if: inputs.commit-fixes && github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'style: apply shell formatting (shellharden + shellcheck + shfmt) [skip ci]'
          branch: ${{ github.head_ref || github.ref_name }}
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

  # MegaLinter (comprehensive multi-language linting)
  megalinter:
    name: MegaLinter
    if: inputs.run-megalinter
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    permissions:
      contents: write
      issues: write
      pull-requests: write
      statuses: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0080882f6c36860b6ba35c610c98ce87d4e2f26f # v2.10.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter@v9
        env:
          VALIDATE_ALL_CODEBASE: ${{ inputs.megalinter-validate-all }}
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          APPLY_FIXES: ${{ inputs.megalinter-apply-fixes && 'all' || 'none' }}
          MEGALINTER_CONFIG: ${{ inputs.megalinter-config }}
          FILTER_REGEX_EXCLUDE: ${{ inputs.megalinter-exclude-dirs }}
          ENABLE_GITHUB_ACTIONS_STEP_SUMMARY: true

      - name: Archive reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: megalinter-reports
          path: |
            megalinter-reports
            mega-linter.log
          retention-days: 7

      - name: Create summary
        if: always()
        run: |
          {
            echo "## MegaLinter Results"
            echo "- **Status**: ${{ steps.ml.outcome }}"
            echo "- **Branch**: ${{ github.ref_name }}"
          } >> "$GITHUB_STEP_SUMMARY"
          [[ -f megalinter-reports/summary.md ]] && cat megalinter-reports/summary.md >> "$GITHUB_STEP_SUMMARY" || true

      - name: Commit fixes
        if: |
          inputs.commit-fixes &&
          steps.ml.outputs.has_updated_sources == 1 &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'style: apply MegaLinter fixes [skip ci]'
          branch: ${{ github.head_ref || github.ref_name }}
          commit_user_name: megalinter-bot[bot]
          commit_user_email: megalinter-bot[bot]@users.noreply.github.com
