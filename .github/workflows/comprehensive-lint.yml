# Comprehensive Linting Workflow (Reusable)
name: Comprehensive Lint (Reusable)
on:
  workflow_call:
    inputs:
      working-directory:
        type: string
        default: '.'
      apply-shellharden:
        type: boolean
        default: true
      shfmt-indent:
        type: number
        default: 2
      shell-exclude-pattern:
        type: string
        default: '(^|/)\\.(git|cache|claude|venv)(/|$)'
      megalinter-validate-all:
        type: boolean
        default: false
      megalinter-config:
        type: string
        default: '.megalinter.yml'
      megalinter-exclude-dirs:
        type: string
        default: '.github,.git,.cache,node_modules'
      commit-fixes:
        type: boolean
        default: true
      timeout-minutes:
        type: number
        default: 20
permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
env:
  DEBIAN_FRONTEND: noninteractive
jobs:
  shellharden-fix:
    name: Shell Hardening
    if: inputs.apply-shellharden
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
      - name: Install & Run shellharden
        env:
          EXCLUDE: ${{ inputs.shell-exclude-pattern }}
        run: |
          #!/usr/bin/env bash
          set -euo pipefail; shopt -s globstar nullglob
          bin=$HOME/.local/bin; mkdir -p "$bin"; echo "$bin" >> "$GITHUB_PATH"
          curl -sfL https://github.com/anordal/shellharden/releases/latest/download/shellharden-x86_64-unknown-linux-gnu.tar.gz | tar xz -C "$bin" shellharden
          chmod +x "$bin/shellharden"
          mapfile -t files < <({ grep -rIl "^#!" . 2>/dev/null | grep -E "\.(ba)?sh$"; find . -name "*.sh" -type f; } | grep -vE "$EXCLUDE" | sort -u)
          [[ ${#files[@]} -eq 0 ]] && { echo "No shell files"; exit 0; }
          c=0
          for f in "${files[@]}"; do shellharden --replace "$f" &>/dev/null && ((c++)) || :; done
          echo "Hardened $c/${#files[@]} shell files"
      - name: Commit Fixes
        if: inputs.commit-fixes && github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'style: apply shellharden [skip ci]'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      statuses: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter@v8
        env:
          VALIDATE_ALL_CODEBASE: ${{ inputs.megalinter-validate-all }}
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          APPLY_FIXES: all
          MEGALINTER_CONFIG: ${{ inputs.megalinter-config }}
          FILTER_REGEX_EXCLUDE: ${{ inputs.megalinter-exclude-dirs }}
      - name: Archive Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: megalinter-reports
          path: |
            megalinter-reports
            mega-linter.log
      - name: Commit Fixes
        if: inputs.commit-fixes && steps.ml.outputs.has_updated_sources == 1
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'style: apply MegaLinter fixes [skip ci]'
          commit_user_name: megalinter-bot[bot]
          commit_user_email: megalinter-bot[bot]@users.noreply.github.com
