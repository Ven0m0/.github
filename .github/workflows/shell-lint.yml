# Shell Lint & Format (Reusable Workflow)
#
# Required secrets:
#   - PAT (optional): Personal Access Token with repo scope
#     Falls back to github.token if not provided
#
# Security: Uses restricted permissions by default (contents: read)
# Jobs override permissions as needed for commit operations

name: Shell Lint & Format (Reusable)
"on":
  workflow_call:
    inputs:
      exclude_pattern:
        description: Regex pattern to exclude files/directories
        type: string
        default: "(^|/)\\.(git|cache|claude)(/|$)"
        required: false
      shellcheck_severity:
        description: Minimum severity level for ShellCheck (error, warning, info, style)
        type: string
        default: style
        required: false
      shfmt_indent:
        description: Number of spaces for indentation
        type: number
        default: 2
        required: false
      apply_fixes:
        description: Apply automatic fixes (shellharden + shellcheck patches + shfmt)
        type: boolean
        default: true
        required: false
      commit_changes:
        description: Commit and push formatting changes
        type: boolean
        default: true
        required: false
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
jobs:
  lint:
    name: Shell Lint & Format
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.PAT || github.token }}
      - name: Install ShellCheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Cache Shell Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/shellharden
            /usr/local/bin/shfmt
          key: ${{ runner.os }}-shell-tools-v2
      - name: Install Shellharden
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          shellharden_url="https://github.com/anordal/shellharden/releases/latest/download"
          curl -sfL "${shellharden_url}/shellharden-x86_64-unknown-linux-gnu.tar.gz" | \
            sudo tar xz -C /usr/local/bin shellharden
      - name: Install shfmt
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          shfmt_url="https://github.com/mvdan/sh/releases/latest/download"
          curl -sfL "${shfmt_url}/shfmt_v3.10.0_linux_amd64" -o /tmp/shfmt
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt
      - name: Verify Tools
        run: |
          shellcheck --version
          shfmt --version
          shellharden --version
      - name: Find Shell Files
        id: find-files
        env:
          EXCLUDE_PATTERN: ${{ inputs.exclude_pattern }}
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          mapfile -t files < <(
            {
              find . -type f \( -name '*.sh' -o -name '*.bash' -o -name '*bashrc' \
                -o -name '*profile' -o -name 'bash_*' \)
              find . -type f -executable \
                -exec sh -c 'head -n1 "$1" | grep -qE "^#!/.*(bash|sh)"' _ {} \; -print
            } | grep -vE "$EXCLUDE_PATTERN" | sort -u
          )
          echo "file_count=${#files[@]}" >> "$GITHUB_OUTPUT"
          printf '%s\n' "${files[@]}" > /tmp/shell_files.txt
          {
            echo "## Shell Files Found"
            echo "Found ${#files[@]} shell files to lint"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Run ShellCheck
        if: steps.find-files.outputs.file_count > 0
        env:
          SHELLCHECK_OPTS: >-
            --source-path=SCRIPTDIR --external-sources --check-sourced
            --shell=bash --severity=${{ inputs.shellcheck_severity }}
        run: |
          set -euo pipefail
          failed=0
          while IFS= read -r file; do
            echo "Checking: $file"
            shellcheck "$file" || failed=$((failed + 1))
          done < /tmp/shell_files.txt
          {
            echo "## ShellCheck Results"
            echo "- Files checked: $(wc -l < /tmp/shell_files.txt)"
            echo "- Files with issues: $failed"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 0
      - name: Apply Fixes
        if: inputs.apply_fixes && steps.find-files.outputs.file_count > 0
        env:
          SHELLCHECK_OPTS: >-
            --source-path=SCRIPTDIR --external-sources --check-sourced
            --shell=bash --severity=${{ inputs.shellcheck_severity }}
          SHFMT_INDENT: ${{ inputs.shfmt_indent }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          shellharden_count=0
          shellcheck_count=0
          shfmt_count=0
          {
            echo "## Formatting Shell Files"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "Processing: $file"
            # Run shellharden
            echo "  → Running shellharden --replace..."
            if shellharden --replace "$file" 2>/dev/null; then
              shellharden_count=$((shellharden_count + 1))
              echo "    ✓ shellharden applied"
            else
              echo "    ⚠ shellharden skipped"
            fi
            # Run shellcheck fixes
            echo "  → Running shellcheck -f diff | patch -Np1..."
            if shellcheck -f diff "$file" 2>/dev/null | patch -Np1 2>/dev/null; then
              shellcheck_count=$((shellcheck_count + 1))
              echo "    ✓ shellcheck fixes applied"
            else
              echo "    ⚠ shellcheck skipped"
            fi
            # Run shfmt
            echo "  → Running shfmt in-place..."
            if shfmt -i "${SHFMT_INDENT}" -s -ln bash -bn -ci -w "$file" 2>/dev/null; then
              shfmt_count=$((shfmt_count + 1))
              echo "    ✓ shfmt applied"
            else
              echo "    ⚠ shfmt skipped"
            fi
            echo ""
          done < /tmp/shell_files.txt
          {
            echo "### Formatting Summary"
            echo "- **shellharden**: Modified $shellharden_count files"
            echo "- **shellcheck**: Applied fixes to $shellcheck_count files"
            echo "- **shfmt**: Formatted $shfmt_count files"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Check for Changes
        id: check-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
            {
              echo "## Changes Detected"
              echo '```diff'
              git diff --stat
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
            echo "No changes needed" >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Commit and Push
        if: >-
          inputs.commit_changes &&
          steps.check-changes.outputs.changes_detected == 'true' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "style: apply shell formatting (shellharden + shellcheck + shfmt) [skip ci]"
          branch: ${{ github.head_ref || github.ref_name }}
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
